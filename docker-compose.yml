services:
  # TiDB Database Service
  tidb:
    image: pingcap/tidb:nightly
    container_name: echo_mcp_tidb
    ports:
      - "4000:4000"
      - "10080:10080"
    environment:
      - TIDB_BIND_ADDRESS=0.0.0.0
    volumes:
      - tidb_data:/tmp/tidb
      - ./docker/tidb/init:/docker-entrypoint-initdb.d
    networks:
      - echo_mcp_network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:10080/status || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Redis Service
  redis:
    image: redis:7-alpine
    container_name: echo_mcp_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - echo_mcp_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    command: redis-server --appendonly yes

  # FastAPI Application Service
  echo_mcp_app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: echo_mcp_app
    ports:
      - "8000:8000"
    environment:
      # Database settings
      - TIDB_HOST=tidb
      - TIDB_PORT=4000
      - TIDB_USER=root
      - TIDB_PASSWORD=
      - TIDB_DATABASE=echo_mcp_tidb
      # Redis settings
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      # Application settings
      - DEBUG=true
      - APP_NAME=Echo MCP Server
      - APP_VERSION=1.0.0
      - PORT=8000
      # JWT settings
      - JWT_SECRET_KEY=your-secret-key-change-in-production-docker
      - JWT_ALGORITHM=HS256
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30
      - JWT_REFRESH_TOKEN_EXPIRE_DAYS=7
      # Email settings (optional)
      - SMTP_SERVER=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_USERNAME=
      - SMTP_PASSWORD=
      - EMAIL_FROM=
      # CORS settings
      - CORS_ORIGINS=["http://localhost:3000", "http://localhost:8080", "http://localhost:8000"]
      - CORS_ALLOW_CREDENTIALS=true
    volumes:
      - ./app:/app/app:ro # Mount for development hot reload
    networks:
      - echo_mcp_network
    # This section ensures the app waits for the database and cache to be healthy
    depends_on:
      tidb:
        condition: service_healthy # Waits for the tidb healthcheck to pass
      redis:
        condition: service_healthy # Waits for the redis healthcheck to pass
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import requests; requests.get('http://localhost:8000/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # Development service with hot reload
  echo_mcp_dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: echo_mcp_dev
    ports:
      - "8001:8000"
    environment:
      # Database settings
      - TIDB_HOST=tidb
      - TIDB_PORT=4000
      - TIDB_USER=root
      - TIDB_PASSWORD=
      - TIDB_DATABASE=echo_mcp_tidb
      # Redis settings
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      # Application settings
      - DEBUG=true
      - APP_NAME=Echo MCP Server (Dev)
      - APP_VERSION=1.0.0-dev
      - PORT=8000
      # JWT settings
      - JWT_SECRET_KEY=dev-secret-key-not-for-production
      - JWT_ALGORITHM=HS256
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30
      - JWT_REFRESH_TOKEN_EXPIRE_DAYS=7
    volumes:
      - ./app:/app/app # Mount for development hot reload
    networks:
      - echo_mcp_network
    depends_on:
      tidb:
        condition: service_healthy
      redis:
        condition: service_healthy
    profiles:
      - dev
    restart: unless-stopped

volumes:
  tidb_data:
    driver: local
  redis_data:
    driver: local

networks:
  echo_mcp_network:
    driver: bridge
